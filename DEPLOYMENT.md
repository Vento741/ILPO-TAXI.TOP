# üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é ILPO-TAXI –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

## üìã –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é

### 1. –û–±–Ω–æ–≤–∏—Ç–µ `.env` —Ñ–∞–π–ª
–ó–∞–º–µ–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ `.env` —Ñ–∞–π–ª–µ:

#### üîë –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
```bash
# –ü–æ–ª—É—á–∏—Ç–µ —É @BotFather –≤ Telegram
TELEGRAM_BOT_TOKEN=YOUR_REAL_BOT_TOKEN

# –í–∞—à–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ PostgreSQL
DATABASE_PASSWORD=your_strong_password_here
DATABASE_USER=ilpo_user
DATABASE_NAME=ilpo_taxi_db

# –ü–∞—Ä–æ–ª—å –¥–ª—è Redis
REDIS_PASSWORD=your_redis_password_here

# –°–µ–∫—Ä–µ—Ç–Ω—ã–µ –∫–ª—é—á–∏ (–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Å–ª—É—á–∞–π–Ω—ã–µ)
API_SECRET_KEY=your_super_secret_api_key_minimum_32_characters_long
JWT_SECRET_KEY=your_jwt_secret_key_for_tokens_very_long_and_secure

# –ü–æ–ª—É—á–∏—Ç–µ —á–µ—Ä–µ–∑ @userinfobot –≤ Telegram
ADMIN_IDS=123456789,987654321
MANAGER_IDS=111111111,222222222

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ False –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω
DEBUG=False
```

## üñ•Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä Ubuntu/Debian

### 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
```bash
sudo apt update && sudo apt upgrade -y
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python 3.10+
```bash
sudo apt install python3.10 python3.10-venv python3-pip -y
```

### 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgreSQL
```bash
sudo apt install postgresql postgresql-contrib -y
sudo systemctl start postgresql
sudo systemctl enable postgresql

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
sudo -u postgres psql
```

–í PostgreSQL –∫–æ–Ω—Å–æ–ª–∏:
```sql
CREATE USER ilpo_user WITH PASSWORD 'your_strong_password_here';
CREATE DATABASE ilpo_taxi_db OWNER ilpo_user;
GRANT ALL PRIVILEGES ON DATABASE ilpo_taxi_db TO ilpo_user;
\q
```

### 4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Redis
```bash
sudo apt install redis-server -y
sudo systemctl start redis
sudo systemctl enable redis

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–æ–ª—è Redis
sudo nano /etc/redis/redis.conf
# –ù–∞–π–¥–∏—Ç–µ –∏ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ: requirepass your_redis_password_here
sudo systemctl restart redis
```

### 5. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Nginx
```bash
sudo apt install nginx -y
sudo systemctl start nginx
sudo systemctl enable nginx
```

## üìÅ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
```bash
sudo mkdir -p /var/www/ilpo-taxi
sudo chown $USER:$USER /var/www/ilpo-taxi
cd /var/www/ilpo-taxi
```

### 2. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
```bash
# –ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä
git clone YOUR_REPOSITORY_URL .
# –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∞—Ä—Ö–∏–≤ –∏ —Ä–∞—Å–ø–∞–∫—É–π—Ç–µ
```

### 3. –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
python3.10 -m venv venv
source venv/bin/activate
```

### 4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
pip install --upgrade pip
pip install -r requirements.txt
pip install gunicorn uvloop
```

### 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–∞—à –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π .env —Ñ–∞–π–ª
cp .env.example .env
nano .env
# –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
```

### 6. –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
```bash
# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
alembic -c database/alembic.ini upgrade head
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤

### 1. –°–æ–∑–¥–∞–Ω–∏–µ systemd —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è FastAPI
```bash
sudo nano /etc/systemd/system/ilpo-taxi-api.service
```

–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:
```ini
[Unit]
Description=ILPO-TAXI FastAPI Application
After=network.target

[Service]
Type=exec
User=www-data
Group=www-data
WorkingDirectory=/var/www/ilpo-taxi
Environment=PATH=/var/www/ilpo-taxi/venv/bin
EnvironmentFile=/var/www/ilpo-taxi/.env
ExecStart=/var/www/ilpo-taxi/venv/bin/gunicorn -w 4 -k uvicorn.workers.UvicornWorker main:app --bind 127.0.0.1:8000
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

### 2. –°–æ–∑–¥–∞–Ω–∏–µ systemd —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è Telegram –±–æ—Ç–∞
```bash
sudo nano /etc/systemd/system/ilpo-taxi-bot.service
```

–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:
```ini
[Unit]
Description=ILPO-TAXI Telegram Bot
After=network.target

[Service]
Type=exec
User=www-data
Group=www-data
WorkingDirectory=/var/www/ilpo-taxi/telegram_bot
Environment=PATH=/var/www/ilpo-taxi/venv/bin
EnvironmentFile=/var/www/ilpo-taxi/.env
ExecStart=/var/www/ilpo-taxi/venv/bin/python main.py
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx
```bash
sudo nano /etc/nginx/sites-available/ilpo-taxi
```

–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:
```nginx
# –°–Ω–∞—á–∞–ª–∞ –¥–µ–ª–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
sudo cp /etc/nginx/sites-available/ilpo-taxi /etc/nginx/sites-available/ilpo-taxi.backup

# –ó–∞–º–µ–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å —É—á–µ—Ç–æ–º IP-–∞–¥—Ä–µ—Å–∞
sudo tee /etc/nginx/sites-available/ilpo-taxi > /dev/null << 'EOF'
# HTTP —Å–µ—Ä–≤–µ—Ä - —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ HTTPS
server {
    listen 80;
    server_name ilpo-taxi.top www.ilpo-taxi.top 81.177.6.46;

    # –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ HTTPS
    return 301 https://$server_name$request_uri;
}

# HTTPS —Å–µ—Ä–≤–µ—Ä - –æ—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
server {
    listen 443 ssl http2;
    server_name ilpo-taxi.top www.ilpo-taxi.top 81.177.6.46;

    # SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã (–±—É–¥–µ–º –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å Let's Encrypt –ø–æ–∑–∂–µ)
    ssl_certificate /etc/letsencrypt/live/ilpo-taxi.top/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/ilpo-taxi.top/privkey.pem;

    # SSL –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ FastAPI
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # Webhook –¥–ª—è Telegram –±–æ—Ç–∞
    location /webhook/telegram {
        proxy_pass http://127.0.0.1:8000/webhook/telegram;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã (CSS, JS, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)
    location /static/ {
        alias /var/www/ILPO-TAXI.TOP/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
        location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # Uploaded files (if any)
    location /uploads/ {
        alias /var/www/ILPO-TAXI.TOP/uploads/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        
        # Disable execution of scripts
        location ~* \.(php|pl|py|jsp|asp|sh|cgi)$ {
            deny all;
        }
    }

    # Disable nginx version
    server_tokens off;
    
    # Default security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
}
EOF
```

### 4. –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx
```bash
sudo ln -s /etc/nginx/sites-available/ilpo-taxi /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

## üîí –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Certbot
```bash
sudo apt install certbot python3-certbot-nginx -y
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
```bash
sudo certbot --nginx -d ilpo-taxi.top -d www.ilpo-taxi.top
```

## üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
```bash
sudo chown -R www-data:www-data /var/www/ilpo-taxi
sudo chmod -R 755 /var/www/ilpo-taxi
```

### 2. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –ª–æ–≥–æ–≤
```bash
sudo mkdir -p /var/log/ilpo-taxi
sudo chown www-data:www-data /var/log/ilpo-taxi
```

### 3. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
```bash
sudo systemctl daemon-reload
sudo systemctl enable ilpo-taxi-api
sudo systemctl enable ilpo-taxi-bot
sudo systemctl start ilpo-taxi-api
sudo systemctl start ilpo-taxi-bot
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
```bash
sudo systemctl status ilpo-taxi-api
sudo systemctl status ilpo-taxi-bot
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
```bash
# –õ–æ–≥–∏ FastAPI
sudo journalctl -u ilpo-taxi-api -f

# –õ–æ–≥–∏ Telegram –±–æ—Ç–∞
sudo journalctl -u ilpo-taxi-bot -f

# –õ–æ–≥–∏ Nginx
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

## üîß –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É `/start` –±–æ—Ç—É –æ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook –¥–ª—è Telegram
```bash
# –ß–µ—Ä–µ–∑ curl –∏–ª–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
curl -X POST "https://api.telegram.org/bot<BOT_TOKEN>/setWebhook" \
     -H "Content-Type: application/json" \
     -d '{"url":"https://ilpo-taxi.top/webhook/telegram"}'
```

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ firewall
```bash
sudo ufw enable
sudo ufw allow ssh
sudo ufw allow 'Nginx Full'
```

### 2. –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
```bash
# –î–æ–±–∞–≤—å—Ç–µ –≤ crontab
sudo crontab -e
# 0 4 * * 0 apt update && apt upgrade -y
```

## üìù –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
```bash
sudo systemctl restart ilpo-taxi-api
sudo systemctl restart ilpo-taxi-bot
sudo systemctl reload nginx
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
```bash
cd /var/www/ilpo-taxi
git pull origin main
source venv/bin/activate
pip install -r requirements.txt
alembic -c database/alembic.ini upgrade head
sudo systemctl restart ilpo-taxi-api
sudo systemctl restart ilpo-taxi-bot
```

### –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
```bash
pg_dump -U ilpo_user -h localhost ilpo_taxi_db > backup_$(date +%Y%m%d_%H%M%S).sql
```

## ‚ùó –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ó–∞–º–µ–Ω–∏—Ç–µ –≤—Å–µ –ø–∞—Ä–æ–ª–∏** –≤ `.env` —Ñ–∞–π–ª–µ –Ω–∞ –Ω–∞–¥–µ–∂–Ω—ã–µ
2. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –±—ç–∫–∞–ø—ã** –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
3. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ª–æ–≥–∏** –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –æ—à–∏–±–æ–∫
4. **–û–±–Ω–æ–≤–ª—è–π—Ç–µ —Å–∏—Å—Ç–µ–º—É** —Ä–µ–≥—É–ª—è—Ä–Ω–æ
5. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å** –ø–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

## üÜò Troubleshooting

### –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å PostgreSQL
sudo systemctl status postgresql

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
psql -U ilpo_user -h localhost -d ilpo_taxi_db
```

### –ü—Ä–æ–±–ª–µ–º—ã —Å Redis
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å Redis
sudo systemctl status redis

# –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
redis-cli -a your_redis_password_here ping
```

### –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º
```bash
# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
sudo certbot renew --dry-run
``` 