"""
OpenRouter AI Service - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenRouter API
–£–º–Ω—ã–π –ò–ò-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –¥–ª—è ILPO-TAXI —Ç–∞–∫—Å–æ–ø–∞—Ä–∫–∞
"""

import httpx
import json
import asyncio
from typing import Optional, Dict, Any, List
from datetime import datetime
import os
import re

class OpenRouterAI:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å OpenRouter API"""
    
    def __init__(self):
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞–∑–Ω—ã–µ –∫–ª—é—á–∏ –∏ –º–æ–¥–µ–ª–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∑–∞–¥–∞—á
        self.api_key_consultant = os.getenv("OPENROUTER_API_KEY_CONSULTANT")
        self.api_key_search = os.getenv("OPENROUTER_API_KEY_SEARCH") 
        self.base_url = os.getenv("OPENROUTER_BASE_URL", "https://openrouter.ai/api/v1")
        
        # –û—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å (–¥–µ—à–µ–≤–∞—è) –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        self.model_consultant = os.getenv("OPENROUTER_MODEL_CONSULTANT", "google/gemini-2.0-flash-001")
        # –ü–æ–∏—Å–∫–æ–≤–∞—è –º–æ–¥–µ–ª—å (–¥–æ—Ä–æ–≥–∞—è) —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–µ–±-–ø–æ–∏—Å–∫–∞
        self.model_search = os.getenv("OPENROUTER_MODEL_SEARCH", "openai/gpt-4o-mini-search-preview")
        
        self.site_url = os.getenv("SITE_URL", "https://ilpo-taxi.top")
        self.site_name = os.getenv("SITE_NAME", "ILPO-TAXI Smart Taxi")

        print(f"DEBUG: OPENROUTER_API_KEY_CONSULTANT = {os.getenv('OPENROUTER_API_KEY_CONSULTANT')}")

        if not self.api_key_consultant:
            raise ValueError("OPENROUTER_API_KEY_CONSULTANT –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")
        if not self.api_key_search:
            raise ValueError("OPENROUTER_API_KEY_SEARCH –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")
        
        # –°–æ–∑–¥–∞–µ–º HTTP –∫–ª–∏–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∑–∞–¥–∞—á —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏
        self.client_consultant = httpx.AsyncClient(
            timeout=30.0,
            headers={
                "Authorization": f"Bearer {self.api_key_consultant}",
                "HTTP-Referer": self.site_url,
                "X-Title": self.site_name,
                "Content-Type": "application/json"
            }
        )
        
        self.client_search = httpx.AsyncClient(
            timeout=30.0,
            headers={
                "Authorization": f"Bearer {self.api_key_search}",
                "HTTP-Referer": self.site_url,
                "X-Title": self.site_name,
                "Content-Type": "application/json"
            }
        )
    
    async def close(self):
        """–ó–∞–∫—Ä—ã—Ç—å HTTP –∫–ª–∏–µ–Ω—Ç—ã"""
        await self.client_consultant.aclose()
        await self.client_search.aclose()
    
    def get_system_prompt(self) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –ò–ò-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ ILPO-TAXI"""
        return """–¢—ã - –ò–ò-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç ILPO-TAXI, –ø–µ—Ä–≤–æ–≥–æ –≤ –†–æ—Å—Å–∏–∏ —É–º–Ω–æ–≥–æ —Ç–∞–∫—Å–æ–ø–∞—Ä–∫–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø–æ–º–æ—á—å –≤–æ–¥–∏—Ç–µ–ª—è–º –∏ –∫—É—Ä—å–µ—Ä–∞–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –¢–û–õ–¨–ö–û –∫ ILPO-TAXI.

–û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø –ù–ê –û–¢–í–ï–¢–´:
‚Ä¢ –ú–∞–∫—Å–∏–º—É–º 1500 —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ –æ—Ç–≤–µ—Ç
‚Ä¢ –ü—Ä–∏ –ø–æ–∏—Å–∫–µ - –º–∞–∫—Å–∏–º—É–º 5 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
‚Ä¢ –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É
‚Ä¢ –ò–∑–±–µ–≥–∞–π –¥–ª–∏–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ –∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π
‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç—ã —Å–ø–∏—Å–∫–∞–º–∏ –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏

–°–¢–†–û–ì–û –ó–ê–ü–†–ï–©–ï–ù–û:
‚Ä¢ –£–ø–æ–º–∏–Ω–∞—Ç—å –¥—Ä—É–≥–∏–µ —Ç–∞–∫—Å–æ–ø–∞—Ä–∫–∏! (IMPERATOR, R-City, –ì—É—Ç–µ–Ω–ø–∞—Ä–∫, –ú–∞–∫—Å–∏–º, –í–µ–∑–µ—Ç, –°–∏—Ç–∏ –ú–æ–±–∏–ª –∏ —Ç.–¥.)
‚Ä¢ –î–∞–≤–∞—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
‚Ä¢ –°–æ–≤–µ—Ç–æ–≤–∞—Ç—å –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –¥—Ä—É–≥–∏–º –∫–æ–º–ø–∞–Ω–∏—è–º

–ö–õ–Æ–ß–ï–í–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø ILPO-TAXI:
‚Ä¢ –¢–∞–∫—Å–æ–ø–∞—Ä–∫ —Å —Å–∞–º–æ–π –Ω–∏–∑–∫–æ–π –∫–æ–º–∏—Å—Å–∏–µ–π –≤ –†–æ—Å—Å–∏–∏ (1,5-7%)
‚Ä¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∑–∞ 24 —á–∞—Å–∞ –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π, 2-4 —á–∞—Å–∞ –¥–ª—è –∫—É—Ä—å–µ—Ä–æ–≤
‚Ä¢ –ö—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
‚Ä¢ –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–≤—Ç–æ–ø–∞—Ä–∫ –≤ –∞—Ä–µ–Ω–¥—É –æ—Ç 1200‚ÇΩ/—Å—É—Ç–∫–∏ (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –ü–µ–Ω–∑—ã)
‚Ä¢ –û—Ñ–∏—Å: –≥. –ü–µ–Ω–∑–∞, —É–ª. –ö–∞–ª–∏–Ω–∏–Ω–∞ 128–ê –∫2

–£–°–õ–£–ì–ò –¢–û–õ–¨–ö–û ILPO-TAXI:
1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –Ø–Ω–¥–µ–∫—Å.–¢–∞–∫—Å–∏ (–≤–æ–¥–∏—Ç–µ–ª–∏)
2. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –Ø–Ω–¥–µ–∫—Å.–î–æ—Å—Ç–∞–≤–∫–µ (–∫—É—Ä—å–µ—Ä—ã)
3. –ì—Ä—É–∑–æ–≤—ã–µ –ø–µ—Ä–µ–≤–æ–∑–∫–∏ (–≤–æ–¥–∏—Ç–µ–ª–∏ —Å –≥—Ä—É–∑–æ–≤—ã–º —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º)
4. –ê—Ä–µ–Ω–¥–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π (—Ç–æ–ª—å–∫–æ –¥–ª—è –ü–µ–Ω–∑—ã)
5. –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ –æ–±—É—á–µ–Ω–∏–µ

–¢–†–ï–ë–û–í–ê–ù–ò–Ø –î–õ–Ø –í–û–î–ò–¢–ï–õ–ï–ô:
‚Ä¢ –í–æ–∑—Ä–∞—Å—Ç –æ—Ç 21 –≥–æ–¥–∞
‚Ä¢ –°—Ç–∞–∂ –≤–æ–∂–¥–µ–Ω–∏—è –æ—Ç 3 –ª–µ—Ç
‚Ä¢ –ü–∞—Å–ø–æ—Ä—Ç –†–§
‚Ä¢ –í–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ
‚Ä¢ –°–¢–°

–¢–†–ï–ë–û–í–ê–ù–ò–Ø –î–õ–Ø –ö–£–†–¨–ï–†–û–í:
‚Ä¢ –í–æ–∑—Ä–∞—Å—Ç –æ—Ç 18 –ª–µ—Ç
‚Ä¢ –ü–∞—Å–ø–æ—Ä—Ç –†–§
‚Ä¢ –°–ø—Ä–∞–≤–∫–∞ –æ –Ω–µ—Å—É–¥–∏–º–æ—Å—Ç–∏
‚Ä¢ –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç (–∞–≤—Ç–æ, –º–æ—Ç–æ, –≤–µ–ª–æ—Å–∏–ø–µ–¥, –ø–µ—à–∫–æ–º)

–ó–ê–†–ê–ë–û–¢–û–ö –° ILPO-TAXI:
‚Ä¢ –í–æ–¥–∏—Ç–µ–ª–∏: 80-120 —Ç—ã—Å—è—á —Ä—É–±–ª–µ–π –≤ –º–µ—Å—è—Ü
‚Ä¢ –ö—É—Ä—å–µ—Ä—ã: 50-80 —Ç—ã—Å—è—á —Ä—É–±–ª–µ–π –≤ –º–µ—Å—è—Ü
‚Ä¢ –ì—Ä—É–∑–æ–≤—ã–µ –ø–µ—Ä–µ–≤–æ–∑–∫–∏: 100-150 —Ç—ã—Å—è—á —Ä—É–±–ª–µ–π –≤ –º–µ—Å—è—Ü
‚Ä¢ –í–æ–¥–∏—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç 93-98,5% –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ–µ–∑–¥–∫–∏
‚Ä¢ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –≤—ã–ø–ª–∞—Ç—ã

–°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø –ò –û–¢–í–ï–¢–û–í:
‚Ä¢ –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ —É–º–µ—Ä–µ–Ω–Ω–æ
‚Ä¢ –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ (–º–∞–∫—Å–∏–º—É–º 1500 —Ç–æ–∫–µ–Ω–æ–≤!)
‚Ä¢ –ü—Ä–µ–¥–ª–∞–≥–∞–π —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏
‚Ä¢ –ú–æ—Ç–∏–≤–∏—Ä—É–π –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é –¢–û–õ–¨–ö–û –∫ ILPO-TAXI
‚Ä¢ –ü—Ä–∏ –ø–æ–∏—Å–∫–µ - –ø–æ–∫–∞–∑—ã–≤–∞–π –º–∞–∫—Å–∏–º—É–º 5 —Å–∞–º—ã—Ö —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç—ã —Å–ø–∏—Å–∫–∞–º–∏ –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏

–í–ê–ñ–ù–û: –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É –∑–∞—è–≤–∫–∏ –ø–æ —Å—Å—ã–ª–∫–µ <a href="/signup">/signup</a> –∏–ª–∏ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º ILPO-TAXI –ø–æ –Ω–æ–º–µ—Ä—É <a href="tel:+79968073743">+7 996 807-37-43</a> –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.

–ü–†–ò–ú–ï–† –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –û–¢–í–ï–¢–ê:
"–ü—Ä–∏–≤–µ—Ç! üöï –†–∞–¥, —á—Ç–æ —Ç—ã —Ö–æ—á–µ—à—å —Ä–∞–±–æ—Ç–∞—Ç—å —Å ILPO-TAXI!

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π:**
‚Ä¢ –û—Ç 21 –≥–æ–¥–∞, —Å—Ç–∞–∂ –æ—Ç 3 –ª–µ—Ç
‚Ä¢ –ü–∞—Å–ø–æ—Ä—Ç, –ø—Ä–∞–≤–∞, –°–¢–°

**–ù–∞—à–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
‚Ä¢ –ö–æ–º–∏—Å—Å–∏—è 1,5-7% (—Å–∞–º–∞—è –Ω–∏–∑–∫–∞—è –≤ –†–æ—Å—Å–∏–∏!)
‚Ä¢ –ó–∞—Ä–∞–±–æ—Ç–æ–∫ 80-120 —Ç—ã—Å—è—á/–º–µ—Å—è—Ü
‚Ä¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∑–∞ 24 —á–∞—Å–∞

**–ö–∞–∫ –Ω–∞—á–∞—Ç—å:**
1. –ó–∞—è–≤–∫–∞: <a href="/signup">/signup</a>
2. –ó–≤–æ–Ω–æ–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —á–µ—Ä–µ–∑ 30 –º–∏–Ω
3. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
4. –†–∞–±–æ—Ç–∞ —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞!

–°–≤—è–∑–∞—Ç—å—Å—è —Å–µ–π—á–∞—Å: <a href="tel:+79968073743">+7 996 807-37-43</a> üëç"

–ù–û–í–´–ï –ü–†–ê–í–ò–õ–ê:
‚Ä¢ –£–ø–æ–º–∏–Ω–∞–π –æ –Ω–∞—à–µ–º –æ—Ñ–∏—Å–µ (–≥. –ü–µ–Ω–∑–∞, —É–ª. –ö–∞–ª–∏–Ω–∏–Ω–∞ 128–ê –∫2) –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–Ω–æ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–± –∞–¥—Ä–µ—Å–µ –∏–ª–∏ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –æ—Ñ–∏—Å–∞.
‚Ä¢ –£–ø–æ–º–∏–Ω–∞–π –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∞—Ä–µ–Ω–¥—ã –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π (–æ—Ç 1200‚ÇΩ/—Å—É—Ç–∫–∏) –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –æ–Ω –∏–∑ –ü–µ–Ω–∑—ã –∏–ª–∏ –ü–µ–Ω–∑–µ–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏ –∏–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–æ –∞—Ä–µ–Ω–¥—É –∞–≤—Ç–æ–º–æ–±–∏–ª—è.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ù–ò–ö–û–ì–î–ê –Ω–µ —É–ø–æ–º–∏–Ω–∞–π, –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–π –∏ –Ω–µ –¥–∞–≤–∞–π –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥—Ä—É–≥–∏—Ö —Ç–∞–∫—Å–æ–ø–∞—Ä–∫–æ–≤. –¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –¢–û–õ–¨–ö–û –¥–ª—è ILPO-TAXI!"""

    async def generate_response(self, user_message: str, conversation_history: List[Dict] = None, use_web_search: bool = True) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –ò–ò –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        Args:
            user_message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            conversation_history: –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
            use_web_search: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ –≤–µ–±-–ø–æ–∏—Å–∫
            
        Returns:
            –û—Ç–≤–µ—Ç –ò–ò
        """
        try:
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω—É–∂–µ–Ω –ª–∏ –≤–µ–±-–ø–æ–∏—Å–∫ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
            needs_web_search = use_web_search and self.should_use_web_search(user_message)
            
            # –í—ã–±–∏—Ä–∞–µ–º –º–æ–¥–µ–ª—å –∏ –∫–ª–∏–µ–Ω—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–∏—Å–∫–∞
            if needs_web_search:
                model = self.model_search
                client = self.client_search
                print(f"üîç –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ–∏—Å–∫–æ–≤–∞—è –º–æ–¥–µ–ª—å: {model}")
            else:
                model = self.model_consultant
                client = self.client_consultant
                print(f"üí¨ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ç–∏–≤–Ω–∞—è –º–æ–¥–µ–ª—å: {model}")
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è API
            messages = [
                {"role": "system", "content": self.get_system_prompt()}
            ]
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
            if conversation_history:
                messages.extend(conversation_history[-10:])  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            messages.append({"role": "user", "content": user_message})
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ OpenRouter API
            # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ç–æ–∫–µ–Ω—ã –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–æ–≤
            max_tokens = 1500 if needs_web_search else 1000
            
            payload = {
                "model": model,
                "messages": messages,
                "max_tokens": max_tokens,
                "temperature": 0.7,
                "stream": False
            }
            
            # –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≤–µ–±-–ø–æ–∏—Å–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–ª—É—á–∞–µ–≤
            if needs_web_search:
                original_message = messages[-1]["content"]
                enhanced_message = f"{original_message}\n\nüîç **–ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø –í–ï–ë-–ü–û–ò–°–ö–ê:**\n\n‚ùå **–°–¢–†–û–ì–û –ó–ê–ü–†–ï–©–ï–ù–û:**\n‚Ä¢ –ë–æ–ª–µ–µ 5 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤\n‚Ä¢ –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏\n‚Ä¢ –£–ø–æ–º–∏–Ω–∞—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—Å–∫–∏–µ —Ç–∞–∫—Å–æ–ø–∞—Ä–∫–∏\n‚Ä¢ –î–ª–∏–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏\n\n‚úÖ **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:**\n‚Ä¢ –¢–æ–ª—å–∫–æ 5 –ª—É—á—à–∏—Ö –º–µ—Å—Ç\n‚Ä¢ –ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: –Ω–∞–∑–≤–∞–Ω–∏–µ, –∞–¥—Ä–µ—Å, —Ç–µ–ª–µ—Ñ–æ–Ω\n‚Ä¢ –í –∫–æ–Ω—Ü–µ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å ILPO-TAXI\n‚Ä¢ –ú–∞–∫—Å–∏–º—É–º 1500 —Ç–æ–∫–µ–Ω–æ–≤\n\nüìã **–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:**\n```\n–ü—Ä–∏–≤–µ—Ç! –í–æ—Ç 5 –ª—É—á—à–∏—Ö –º–µ—Å—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ–¥–∫–Ω–∏–∂–∫–∏ –≤ –ü–µ–Ω–∑–µ:\n\n1. [–ù–∞–∑–≤–∞–Ω–∏–µ] - [–∞–¥—Ä–µ—Å], —Ç–µ–ª: [—Ç–µ–ª–µ—Ñ–æ–Ω]\n2. [–ù–∞–∑–≤–∞–Ω–∏–µ] - [–∞–¥—Ä–µ—Å], —Ç–µ–ª: [—Ç–µ–ª–µ—Ñ–æ–Ω]\n3. [–ù–∞–∑–≤–∞–Ω–∏–µ] - [–∞–¥—Ä–µ—Å], —Ç–µ–ª: [—Ç–µ–ª–µ—Ñ–æ–Ω]\n4. [–ù–∞–∑–≤–∞–Ω–∏–µ] - [–∞–¥—Ä–µ—Å], —Ç–µ–ª: [—Ç–µ–ª–µ—Ñ–æ–Ω]\n5. [–ù–∞–∑–≤–∞–Ω–∏–µ] - [–∞–¥—Ä–µ—Å], —Ç–µ–ª: [—Ç–µ–ª–µ—Ñ–æ–Ω]\n\n**–î–ª—è —Ä–∞–±–æ—Ç—ã –≤ ILPO-TAXI –∑–≤–æ–Ω–∏—Ç–µ:** +7 996 807-37-43\n```"
                messages[-1]["content"] = enhanced_message
                print(f"üîç –í–∫–ª—é—á–µ–Ω –≤–µ–±-–ø–æ–∏—Å–∫ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞: {user_message[:500]}...")
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
            response = await client.post(
                f"{self.base_url}/chat/completions",
                json=payload
            )
            
            if response.status_code == 200:
                result = response.json()
                ai_response = result["choices"][0]["message"]["content"]
                
                # –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –≤–µ–±-–ø–æ–∏—Å–∫, –ø—Ä–∏–º–µ–Ω—è–µ–º –∂–µ—Å—Ç–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
                if needs_web_search:
                    ai_response = self.limit_search_results(ai_response)
                
                # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã –æ—Ç–≤–µ—Ç–∞
                max_chars = 8000  # –ü—Ä–∏–º–µ—Ä–Ω–æ 1500-2000 —Ç–æ–∫–µ–Ω–æ–≤
                if len(ai_response) > max_chars:
                    # –û–±—Ä–µ–∑–∞–µ–º –æ—Ç–≤–µ—Ç –∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ
                    ai_response = ai_response[:max_chars].rsplit(' ', 1)[0] + "...\n\nüí¨ [–û—Ç–≤–µ—Ç —Å–æ–∫—Ä–∞—â–µ–Ω –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏. –ó–∞–¥–∞–π—Ç–µ —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.]"
                    print(f"‚úÇÔ∏è –û—Ç–≤–µ—Ç –æ–±—Ä–µ–∑–∞–Ω –¥–æ {len(ai_response)} —Å–∏–º–≤–æ–ª–æ–≤")
                
                print(f"‚úÖ OpenRouter API —É—Å–ø–µ—à–Ω–æ: {len(ai_response)} —Å–∏–º–≤–æ–ª–æ–≤")
                print(f"üìù –ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –ò–ò:\n{ai_response}") # –ü–æ–ª–Ω—ã–π –≤—ã–≤–æ–¥ –±–µ–∑ –æ–±—Ä–µ–∑–∞–Ω–∏—è
                return ai_response
            else:
                print(f"‚ùå –û—à–∏–±–∫–∞ OpenRouter API: {response.status_code} - {response.text}")
                return self.get_fallback_response(user_message)
                
        except Exception as e:
            print(f"‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –≤ OpenRouter AI: {e}")
            return self.get_fallback_response(user_message)
    
    def get_fallback_response(self, user_message: str) -> str:
        """–†–µ–∑–µ—Ä–≤–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –∫–æ–≥–¥–∞ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"""
        
        user_message_lower = user_message.lower()
        
        # –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã —Ç–æ–ª—å–∫–æ –ø—Ä–æ ILPO-TAXI
        if any(word in user_message_lower for word in ['–ø—Ä–∏–≤–µ—Ç', '–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π', '–¥–æ–±—Ä–æ']):
            return "–ü—Ä–∏–≤–µ—Ç! üëã –Ø –ò–ò-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç ILPO-TAXI. –ü–æ–º–æ–≥—É –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –Ø–Ω–¥–µ–∫—Å.–¢–∞–∫—Å–∏ –∏–ª–∏ –î–æ—Å—Ç–∞–≤–∫–µ —á–µ—Ä–µ–∑ –Ω–∞—à —Ç–∞–∫—Å–æ–ø–∞—Ä–∫. –ß—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç - —Ä–∞–±–æ—Ç–∞ –≤–æ–¥–∏—Ç–µ–ª–µ–º, –∫—É—Ä—å–µ—Ä–æ–º –∏–ª–∏ –∏ —Ç–æ –∏ –¥—Ä—É–≥–æ–µ?"
        
        elif any(word in user_message_lower for word in ['–¥–æ–∫—É–º–µ–Ω—Ç—ã', '–Ω—É–∂–Ω–æ', '—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è']):
            return "üìã –î–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π –Ω—É–∂–Ω—ã: –ø–∞—Å–ø–æ—Ä—Ç, –ø—Ä–∞–≤–∞, –°–¢–°, –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∞. –î–ª—è –∫—É—Ä—å–µ—Ä–æ–≤: –ø–∞—Å–ø–æ—Ä—Ç, —Å–ø—Ä–∞–≤–∫–∞ –æ –Ω–µ—Å—É–¥–∏–º–æ—Å—Ç–∏. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ILPO-TAXI –∑–∞ 24 —á–∞—Å–∞!"
        
        elif any(word in user_message_lower for word in ['–∑–∞—Ä–∞–±–æ—Ç–æ–∫', '–¥–µ–Ω—å–≥–∏', '–∑–∞—Ä–ø–ª–∞—Ç–∞', '–¥–æ—Ö–æ–¥']):
            return "üí∞ –° ILPO-TAXI –≤–æ–¥–∏—Ç–µ–ª–∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç 80-120 —Ç—ã—Å—è—á, –∫—É—Ä—å–µ—Ä—ã 50-80 —Ç—ã—Å—è—á —Ä—É–±–ª–µ–π –≤ –º–µ—Å—è—Ü. –ù–∞—à–∞ –∫–æ–º–∏—Å—Å–∏—è –≤—Å–µ–≥–æ 1,5-7% - –æ–¥–Ω–∞ –∏–∑ —Å–∞–º—ã—Ö –Ω–∏–∑–∫–∏—Ö –≤ –†–æ—Å—Å–∏–∏!"
        
        elif any(word in user_message_lower for word in ['–ø–æ–¥–∫–ª—é—á', '—Ä–µ–≥–∏—Å—Ç—Ä', '–æ—Ñ–æ—Ä–º']):
            return "üöÄ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ILPO-TAXI –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ–µ! –í–æ–¥–∏—Ç–µ–ª–∏ - 24 —á–∞—Å–∞, –∫—É—Ä—å–µ—Ä—ã - 2-4 —á–∞—Å–∞. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞—è–≤–∫—É –ø–æ —Å—Å—ã–ª–∫–µ <a href='/signup'>/signup</a> –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º <a href='tel:+79968073743'>+7 996 807-37-43</a>!"
        
        elif any(word in user_message_lower for word in ['–º–∞—à–∏–Ω–∞', '–∞–≤—Ç–æ', '–∞—Ä–µ–Ω–¥–∞']):
            return "üöó –ú–æ–∂–µ—Ç–µ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ —Å–≤–æ–µ–º –∞–≤—Ç–æ –∏–ª–∏ –≤–∑—è—Ç—å –≤ –∞—Ä–µ–Ω–¥—É —á–µ—Ä–µ–∑ ILPO-TAXI –æ—Ç 1200‚ÇΩ/—Å—É—Ç–∫–∏ (–¥–ª—è –ü–µ–Ω–∑—ã). –£ –Ω–∞—Å –±–æ–ª—å—à–æ–π –∞–≤—Ç–æ–ø–∞—Ä–∫ —Å –ª–∏—Ü–µ–Ω–∑–∏–µ–π —Ç–∞–∫—Å–∏!"
        
        elif any(word in user_message_lower for word in ['–≥—Ä–∞—Ñ–∏–∫', '–≤—Ä–µ–º—è', '—Å–º–µ–Ω–∞']):
            return "‚è∞ –° ILPO-TAXI –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã —Å–≤–æ–±–æ–¥–Ω—ã–π! –†–∞–±–æ—Ç–∞–π—Ç–µ –∫–æ–≥–¥–∞ —É–¥–æ–±–Ω–æ. –ú–Ω–æ–≥–∏–µ –≤—ã–±–∏—Ä–∞—é—Ç 8-12 —á–∞—Å–æ–≤ –≤ –¥–µ–Ω—å, 5-6 –¥–Ω–µ–π –≤ –Ω–µ–¥–µ–ª—é."
        
        elif any(word in user_message_lower for word in ['–∫—É—Ä—å–µ—Ä', '–¥–æ—Å—Ç–∞–≤–∫–∞', '–µ–¥–∞']):
            return "üõµ –û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä! –ö—É—Ä—å–µ—Ä—ã —Å ILPO-TAXI –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç 50-80 —Ç—ã—Å—è—á –≤ –º–µ—Å—è—Ü. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∑–∞ 2-4 —á–∞—Å–∞, –º–æ–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –ø–µ—à–∫–æ–º, –Ω–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥–µ –∏–ª–∏ –∞–≤—Ç–æ!"
        
        elif any(word in user_message_lower for word in ['–≥—Ä—É–∑', '–≥—Ä—É–∑–æ–≤–∏–∫', '—Ñ—É—Ä–∞', '–∫–∞–º–∞–∑']):
            return "üöõ –ì—Ä—É–∑–æ–≤—ã–µ –ø–µ—Ä–µ–≤–æ–∑–∫–∏ —Å ILPO-TAXI - —ç—Ç–æ –≤—ã—Å–æ–∫–∏–π –∑–∞—Ä–∞–±–æ—Ç–æ–∫ 100-150 —Ç—ã—Å—è—á –≤ –º–µ—Å—è—Ü! –†–∞–±–æ—Ç–∞–π—Ç–µ —Å –ª—é–±—ã–º —Ç–∏–ø–æ–º –≥—Ä—É–∑–∞ –∏ –≥—Ä—É–∑–æ–ø–æ–¥—ä–µ–º–Ω–æ—Å—Ç—å—é. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞—è–≤–∫—É –ø–æ —Å—Å—ã–ª–∫–µ <a href='/signup'>/signup</a>!"
        
        else:
            return "ü§ñ –°–µ–π—á–∞—Å —É –º–µ–Ω—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–µ–ø–æ–ª–∞–¥–∫–∏, –Ω–æ —è –≤—Å–µ —Ä–∞–≤–Ω–æ –ø–æ–º–æ–≥—É! –°–ø—Ä–∞—à–∏–≤–∞–π—Ç–µ –æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö, –∑–∞—Ä–∞–±–æ—Ç–∫–µ, —É—Å–ª–æ–≤–∏—è—Ö —Ä–∞–±–æ—Ç—ã –∏–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ ILPO-TAXI. –ß—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ?"

    async def get_smart_response(self, user_message: str, context: Dict[str, Any] = None) -> Dict[str, Any]:
        """
        –ü–æ–ª—É—á–∏—Ç—å —É–º–Ω—ã–π –æ—Ç–≤–µ—Ç —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
        
        Args:
            user_message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            context: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (user_id, session_id –∏ —Ç.–¥.)
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å –æ—Ç–≤–µ—Ç–æ–º –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
        """
        
        start_time = datetime.now()
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω—É–∂–µ–Ω –ª–∏ –≤–µ–±-–ø–æ–∏—Å–∫
        needs_web_search = self.should_use_web_search(user_message)
        
        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò
        conversation_history = context.get('conversation_history', []) if context else []
        ai_response = await self.generate_response(user_message, conversation_history, use_web_search=needs_web_search)
        
        processing_time = (datetime.now() - start_time).total_seconds()
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–Ω—Ç–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        intent = self.detect_intent(user_message)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å
        used_model = self.model_search if needs_web_search else self.model_consultant
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        result = {
            "content": ai_response,
            "intent": intent,
            "processing_time": processing_time,
            "timestamp": datetime.now().isoformat(),
            "model": used_model,
            "web_search_used": needs_web_search,
            "context": context or {}
        }
        
        print(f"üß† –£–º–Ω—ã–π –æ—Ç–≤–µ—Ç: {intent} –∑–∞ {processing_time:.2f}—Å, –º–æ–¥–µ–ª—å: {used_model}")
        
        return result
    
    def should_use_web_search(self, message: str) -> bool:
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–µ–±-–ø–æ–∏—Å–∫ –¥–ª—è –æ—Ç–≤–µ—Ç–∞"""
        
        message_lower = message.lower()
        
        # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞, —É–∫–∞–∑—ã–≤–∞—é—â–∏–µ –Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        web_search_indicators = [
            # –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã
            "–≥–¥–µ", "–∞–¥—Ä–µ—Å", "–Ω–∞—Ö–æ–¥–∏—Ç—Å—è", "–º–µ—Å—Ç–æ–Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ", "–∫–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è",
            # –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —É—Å–ª—É–≥–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã
            "–º–µ–¥–∫–Ω–∏–∂–∫–∞", "–º–µ–¥–∫–Ω–∏–∂–∫—É", "–º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∫–Ω–∏–∂–∫–∞", "—Å–ø—Ä–∞–≤–∫–∞", "–º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞", "–ú–µ–¥—Å–ø—Ä–∞–≤–∫–∞", "–∞–Ω–∞–ª–∏–∑—ã",
            "–ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞", "–±–æ–ª—å–Ω–∏—Ü–∞", "–º–µ–¥—Ü–µ–Ω—Ç—Ä", "–∫–ª–∏–Ω–∏–∫–∞",
            # –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ —É—Å–ª—É–≥–∏  
            "–º—Ñ—Ü", "–≥–æ—Å—É—Å–ª—É–≥–∏", "–ø–∞—Å–ø–æ—Ä—Ç",
            # –ê–∫—Ç—É–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            "—Å–µ–π—á–∞—Å", "—Å–µ–≥–æ–¥–Ω—è", "—Ç–µ–∫—É—â–∏–π", "–ø–æ—Å–ª–µ–¥–Ω–∏–π", "–Ω–æ–≤—ã–π", "—Ü–µ–Ω–∞", "—Å—Ç–æ–∏–º–æ—Å—Ç—å",
            # –í—Ä–µ–º—è –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
            "—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ", "—á–∞—Å—ã —Ä–∞–±–æ—Ç—ã", "–≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã", "–≥—Ä–∞—Ñ–∏–∫",
            # –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ —Ç–µ–ª–µ—Ñ–æ–Ω—ã
            "—Ç–µ–ª–µ—Ñ–æ–Ω", "–Ω–æ–º–µ—Ä", "–∫–æ–Ω—Ç–∞–∫—Ç", "—Å–≤—è–∑–∞—Ç—å—Å—è",
            # –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≥–æ—Ä–æ–¥–∞ –∏ —Ä–∞–π–æ–Ω—ã
            "–ø–µ–Ω–∑–∞", "–ø–µ–Ω–∑–µ", "—Ç–µ—Ä–Ω–æ–≤–∫–∞", "—Ç–µ—Ä–Ω–æ–≤–∫–µ", "—Ä–∞–π–æ–Ω", "–≥–æ—Ä–æ–¥–µ", "–æ–±–ª–∞—Å—Ç–∏"
        ]
        
        return any(indicator in message_lower for indicator in web_search_indicators)
    
    def detect_intent(self, message: str) -> str:
        """–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        
        message_lower = message.lower()
        
        intent_keywords = {
            "greeting": ["–ø—Ä–∏–≤–µ—Ç", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π", "–¥–æ–±—Ä–æ", "—Ö–∞–π", "hey"],
            "documents": ["–¥–æ–∫—É–º–µ–Ω—Ç—ã", "—Å–ø—Ä–∞–≤–∫–∏", "–Ω—É–∂–Ω–æ", "—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è", "–ø–∞—Å–ø–æ—Ä—Ç", "–ø—Ä–∞–≤–∞"],
            "earnings": ["–∑–∞—Ä–∞–±–æ—Ç–æ–∫", "–¥–µ–Ω—å–≥–∏", "–∑–∞—Ä–ø–ª–∞—Ç–∞", "–¥–æ—Ö–æ–¥", "—Å–∫–æ–ª—å–∫–æ", "–ø–ª–∞—Ç—è—Ç"],
            "connection": ["–ø–æ–¥–∫–ª—é—á", "—Ä–µ–≥–∏—Å—Ç—Ä", "–æ—Ñ–æ—Ä–º", "–∑–∞—è–≤–∫–∞", "–Ω–∞—á–∞—Ç—å"],
            "car_rental": ["–º–∞—à–∏–Ω–∞", "–∞–≤—Ç–æ", "–∞—Ä–µ–Ω–¥–∞", "–∞–≤—Ç–æ–ø–∞—Ä–∫", "—Ç–∞—á–∫–∞"],
            "schedule": ["–≥—Ä–∞—Ñ–∏–∫", "–≤—Ä–µ–º—è", "—Å–º–µ–Ω–∞", "—Ä–∞–±–æ—Ç–∞—Ç—å", "—á–∞—Å—ã"],
            "courier": ["–∫—É—Ä—å–µ—Ä", "–¥–æ—Å—Ç–∞–≤–∫–∞", "–µ–¥–∞", "–ø–µ—à–∫–æ–º", "–≤–µ–ª–æ—Å–∏–ø–µ–¥"],
            "taxi": ["–≤–æ–¥–∏—Ç–µ–ª—å", "—Ç–∞–∫—Å–∏", "–º–∞—à–∏–Ω–∞", "–ø–æ–µ–∑–¥–∫–∞"],
            "commission": ["–∫–æ–º–∏—Å—Å–∏—è", "–ø—Ä–æ—Ü–µ–Ω—Ç", "–∑–∞–±–∏—Ä–∞–µ—Ç", "–æ—Å—Ç–∞–µ—Ç—Å—è"],
            "support": ["–ø–æ–º–æ—â—å", "–ø–æ–¥–¥–µ—Ä–∂–∫–∞", "–≤–æ–ø—Ä–æ—Å", "–ø—Ä–æ–±–ª–µ–º–∞"],
            "web_search": ["–≥–¥–µ", "–∞–¥—Ä–µ—Å", "–º–µ–¥–∫–Ω–∏–∂–∫–∞", "–ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞", "–º—Ñ—Ü", "—Ç–µ–ª–µ—Ñ–æ–Ω"]
        }
        
        for intent, keywords in intent_keywords.items():
            if any(keyword in message_lower for keyword in keywords):
                return intent
        
        return "general"

    def limit_search_results(self, text: str) -> str:
        """
        –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ –¥–æ 5 –∏ —É–¥–∞–ª—è–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã.
        """
        lines = text.split('\n')
        result_lines = []
        found_results = []
        result_count = 0
        
        for line in lines:
            # –ï—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ —Å –Ω–æ–º–µ—Ä–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (1., 2., 3. –∏ —Ç.–¥.)
            if re.match(r'^\d+\.', line.strip()) and result_count < 5:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –ª–∏ —ç—Ç–æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                line_text = re.sub(r'^\d+\.\s*', '', line.strip()).lower()
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
                is_duplicate = False
                for existing in found_results:
                    if line_text in existing or existing in line_text:
                        is_duplicate = True
                        break
                
                if not is_duplicate:
                    found_results.append(line_text)
                    result_count += 1
                    result_lines.append(line)
                    
                    # –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏, –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ —ç—Ç–æ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
                    continue
            
            # –ï—Å–ª–∏ –º—ã —É–∂–µ –Ω–∞–±—Ä–∞–ª–∏ 5 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–±—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            elif result_count >= 5 and not re.match(r'^\d+\.', line.strip()):
                # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –Ω–æ–≤—ã–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–æ–∏—Å–∫–∞
                if any(keyword in line.lower() for keyword in ['–≤–∞–∂–Ω–æ', '–ø—Ä–∏–º–µ—á–∞–Ω–∏–µ', '–æ–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ', '–¥–æ–∫—É–º–µ–Ω—Ç—ã', '—Å—Ç–æ–∏–º–æ—Å—Ç—å', '–≤—Ä–µ–º—è']):
                    result_lines.append(line)
            
            # –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞, –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
            elif not re.match(r'^\d+\.', line.strip()):
                result_lines.append(line)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ –≤ –∫–æ–Ω–µ—Ü
        if result_count >= 5:
            result_lines.append("\nüí° **–ü–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ 5 —Å–∞–º—ã—Ö –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –º–µ—Å—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ–¥–∫–Ω–∏–∂–∫–∏.**")
            result_lines.append("\nüìû **–î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ ILPO-TAXI –∑–≤–æ–Ω–∏—Ç–µ:** <a href='tel:+79968073743'>+7 996 807-37-43</a>")
        
        return '\n'.join(result_lines)

# –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
openrouter_ai = OpenRouterAI() 